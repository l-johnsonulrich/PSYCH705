---
title: "Week6DemoHypothesisTesting"
output: html_document
date: "2025-09-22"
editor_options: 
  chunk_output_type: console
---

Load libraries and dataset 
```{r}
# Load packages
library(tidyverse)
library(ggplot2)
library(effectsize)   # for Cohen's d, eta^2, etc.
library(pwr)          # for power analysis
library(emmeans)      # for post-hoc effects

# Import the dataset 
hyenas <- as_tibble(read.csv("hyenas.csv"))
hyenas #view head 

# Peek at the data
glimpse(hyenas)

# Example variables in dataset:
# dob (date of birth)
# sex (Male/Female)
# age (in days or years)
# denGraduationAge
# weaningAge
# firstParturitionAge
# socialRank
# dispersalAge
# immigrationAge

#change characters to factor 
hyenas$id <- factor(hyenas$id)
hyenas$sex <- factor(hyenas$sex)
hyenas$mom <- factor(hyenas$mom)
hyenas$clan <- factor(hyenas$clan)

#change dates to dates 
hyenas$birthdate <- as.Date(hyenas$birthdate, format="%Y-%m-%d")
hyenas$dengrad <- as.Date(hyenas$dengrad, format="%Y-%m-%d")
hyenas$weaned <- as.Date(hyenas$weaned, format="%Y-%m-%d")
hyenas$disappeared <- as.Date(hyenas$disappeared, format="%Y-%m-%d")
hyenas$dispersal <- as.Date(hyenas$dispersal, format="%Y-%m-%d")
hyenas$mating <- as.Date(hyenas$mating, format="%Y-%m-%d")

```

## 1. One-sample t-test

Question: Is average age-at-weaning different from 12 months?

Response Variable: Age at weaning (months) (continuous)

Predictor: None/Categorical (only 1 group: hyena cubs)

```{r}
#mutate an age at weaning variable in decimal months
hyenas <-  hyenas %>% mutate(
  ageWeaning = as.numeric(difftime(weaned, birthdate, units = "days")) / 30.4)

#LOOK AT THE RESPONSE VARIABLE FIRST
hist(hyenas$ageWeaning)
#is it approximately normal? 

#what is our sample size? 
sum(!is.na(hyenas$ageWeaning))

#more formal check of normality: 
qqnorm(hyenas$ageWeaning)
qqline(hyenas$ageWeaning)
#plotting deviation from normality 

# formal test (sensitive if n is large), W=1 for normal
shapiro.test(hyenas$ageWeaning)

# T-test
t.test(x=hyenas$ageWeaning, mu=12)


# Effect size (Cohen's d for one-sample)
cohens_d(hyenas$ageWeaning, mu=12)


# Non-parametric: Wilcoxon signed-rank
wilcox.test(hyenas$ageWeaning, mu=12)


#plot the result
ggplot(hyenas, aes(x = "", y = ageWeaning)) +
  geom_violin(fill = "lightblue") +
  geom_boxplot(width = 0.1, outlier.color = "gray40", fill = "white") +
  geom_hline(yintercept = 12, color = "red", linetype = "dashed", linewidth = 1) +
  labs(title = "Weaning Age vs. Hypothesized Mean",
       x = "", y = "Weaning Age (months)") +
  theme_minimal()

```

## 2. Two-sample t-test

Question: Do males and females differ in age at den graduation?

Response: Age at den graduation (months) (continuous)

Predictor: Sex (categorical)

```{r}
#create a new variable for age at den graduation in months

hyenas <- hyenas %>% mutate(ageGrad = as.numeric(difftime(dengrad, birthdate, units = "days")) / 30.4)

#PLOT THE DATA
hist(hyenas$ageGrad)

sum(!is.na(hyenas$ageGrad)) #685

hyenas %>% filter(ageGrad <0)

#filter out both of these hyenas entirely
#hyenas2 <- hyenas %>% filter(ageGrad >0)

#or convert the negative values to NAs
hyenas <- hyenas %>% mutate(ageGrad = if_else(ageGrad > 0, ageGrad, NA))

hist(hyenas$ageGrad)
qqnorm(hyenas$ageGrad)
qqline(hyenas$ageGrad)
#plotting deviation from normality 
shapiro.test(hyenas$ageGrad)
# formal test (sensitive if n is large), W=1 for normal



#formula notation (y=ageGrad, x=sex)
t.test(ageGrad ~ sex, data=hyenas)

#error because we have 3 levels for sex
levels(as.factor(hyenas$sex))
hyenas <- hyenas %>% mutate(sex= case_when(
  sex=="f" ~ "f",
  sex=="m" ~ "m",
  sex=="u" ~ NA))

#try t-test again
t.test(ageGrad ~ sex, data=hyenas)


# Effect size
cohens_d(ageGrad ~ sex, data=hyenas)


# Non-parametric: Mann–Whitney U
wilcox.test(ageGrad ~ sex, data=hyenas)


#Plot the result: 
ggplot(hyenas %>% filter(!is.na(sex)), aes(x = ageGrad, fill=sex)) +
  geom_density(alpha=.5) +
  labs(title = "Den Graduation by Sex",
       x = "Age at Den Graduation", y = "Density") +
  theme_minimal()

#wilcoxen might be even more accurate here because female is likely skewed higher by a few outliers 



```


## 3. Chi-square test of independence

Question(s):

Does litter size affect survival to sexual maturity?

Response variable (DV): surviveToMaturity (Yes/No)

Predictor variable (IV): number_littermates (0/1)

```{r}

#mutate a disappear age because there might be missing data and if they disappear at 5 years without having a dispersal or mating date this would be odd
hyenas <- hyenas %>% 
  mutate(
    ageDeath = as.numeric(difftime(disappeared, birthdate, units = "days")) / 30.4, 
    ageSM = case_when(
      sex=="f" ~ as.numeric(difftime(mating, birthdate, units = "days"))/ 30.4,
      sex=="m" ~ as.numeric(difftime(dispersal, birthdate, units="days"))/ 30.4))

#mutate a variable for survival to SM
hyenas <- hyenas %>% mutate(surviveSM = case_when(
  !is.na(ageSM) ~ "yes",
  ageDeath < 12*4 ~ "no",  
  TRUE ~ NA #if ageDeath greater than 4 years at death without an ageSM value then probability missing data as most hyenas reach SM 2-4 years of age 
))

#how many NAs? 
sum(is.na(hyenas$surviveSM)) #pretty small compared to 1138 obs 
#small enough not to look into why these hyenas were NAs
sum(is.na(hyenas$number_littermates))

#quick look at our data
hyenas %>% filter(!is.na(surviveSM), !is.na(number_littermates)) %>% 
  group_by(nLit = as.factor(number_littermates), surviveSM) %>%
  summarise(n=n()) %>% ungroup() %>%
  ggplot(aes(x=nLit, y=n, fill=surviveSM)) +
  geom_col(position=position_dodge())


# Contingency table

#table function cross tabulates counts of each combination 
hyenasCT <- table(as.factor(hyenas$number_littermates), hyenas$surviveSM)
hyenasCT

# Chi-squared test

#data must be COUNTS
#each datapoint must be independent
#expected cell counts must be >5 (otherwise non-parametric)

chisq.test(hyenasCT)


hyenasCT2 <- hyenasCT[rownames(hyenasCT) != "2",]
hyenasCT2


chiTest <- chisq.test(hyenasCT2)
chiTest

#expected =  (row X column totals) / grand total
#are the observed different from expected? 

chiTest$observed
chiTest$expected


```

## 4. One-way ANOVA

Question: Does social rank (high, mid, low) predict age at first parturition?

Response variable: age at first parturition (continuous)
Predictor: social rank

Assumptions: 

1. Observations MUST be independent. 
2. Normality of **Residuals** (CLT applies here per group)
3. Homogeneity of variance (variance in response variable roughly equal across groups)

```{r}
hyenas <- hyenas %>% mutate(rankCat = case_when(
  stan_rank < -1+2/3 ~ "low",
  stan_rank > -1+2/3 & stan_rank < 1-2/3 ~ "mid",
  stan_rank > 1-2/3 ~ "high"
))

#mutate a categorical rank variable
#standardized rank has scaled rank from an integer to 1 for highest rank and -1 for lowest ranking and 0 for mid-ranking

summary(hyenas$stan_rank)



#LOOKING AT OUR DATA 
#is the variance roughly equal per group? 
ggplot(hyenas %>% filter(sex=="f"), aes(x=ageSM, fill=rankCat)) + geom_density(alpha=.5)
#what is our sample size per group? 
hyenas %>% filter(sex=="f") %>% drop_na(ageSM) %>% group_by(rankCat) %>% summarise(N=n())

#create a new dataframe for just the data we're using 
hyenasF <- hyenas %>% filter(sex=="f") %>% drop_na(ageSM)

#test of homogeneity of variance
car::leveneTest(ageSM ~ rankCat, data=hyenasF)
#greater than 0.05 means no significant variation among variances 

anovaModel <- aov(ageSM ~ rankCat, data=hyenasF)
summary(anovaModel)

 #significant p-value suggests there are differences among categories

# Shapiro-Wilk test on residuals (is the error normal?!)
anovaModel$residuals
shapiro.test(anovaModel$residuals)


# QQ plot (visual check is usually better with large N)
qqnorm(anovaModel$residuals)
qqline(anovaModel$residuals)

#shapiro-wilk significant, but value of .936 mostly normal

# Post-hoc test (where are the differences?)
TukeyHSD(anovaModel)

#both mid and low significantly different from high, but not from each other 

# Non-parametric alternative (if not normal)
kruskal.test(ageSM ~ rankCat, data=hyenasF)

sumAgeFirstP <- hyenasF %>% group_by(rankCat) %>% summarise(
  meanAgeFirstP = mean(ageSM),
  sdAgeFirstP = sd(ageSM),
  N=n(),
  seAgeFirstP = sdAgeFirstP/sqrt(N),
  ciLower = meanAgeFirstP - seAgeFirstP*1.96, 
  ciUpper = meanAgeFirstP + seAgeFirstP*1.96
)

ggplot(sumAgeFirstP, aes(x=factor(rankCat, levels=c("low", "mid", "high"), labels=c("Low", "Mid", "High")), y=meanAgeFirstP)) +
  geom_violin(data=hyenasF, aes(x=factor(rankCat, levels=c("low", "mid", "high"), labels=c("Low", "Mid", "High")), y=ageSM), fill="lightpink")+
  geom_point(size=4, shape=1) +
  geom_errorbar(aes(ymin=ciLower, ymax=ciUpper), width=.4) + 
  theme_bw()+
  labs(y="Average Age at First Parturition", x="Social Rank")



```


## 6. Correlation Example

**Question:** Is maternal social rank associated with the age at first parturition for female hyenas?

**Response variable:** age at first parturition (continuous)  
**Predictor variable:** maternal standardized rank (continuous)  

**Assumptions for Pearson correlation:**
1. Both variables are continuous.  
2. Linear relationship between variables.  
3. Bivariate normality (joint distribution of x and y is roughly normal).  
4. No extreme outliers.  
5. Independence of observations. 

If assumptions are violated, use **Spearman's rank correlation**

```{r}

#are x and y both roughly normal? 
hist(hyenas$stan_rank)
hist(hyenas$ageSM)

# Quick scatterplot (does the relationship look linear?)
ggplot(hyenasF, aes(x=stan_rank, y=ageSM)) +
  geom_point(alpha=0.6) +
  geom_smooth(method="lm", se=FALSE, color="blue")+
  geom_smooth(method="loess", color="red") #default method

#joint normality 
ggplot(hyenasF, aes(x=stan_rank, y=ageSM)) +
  geom_point(alpha=0.5) +
  geom_density_2d(color="blue")  # contour lines showing joint density
#cloud is roughly elliptical and there aren’t strong outliers
#cloud is left skewed, but large sample size correlation should be robust 

#correlation test
cor.test(hyenas$stan_rank, hyenas$ageSM, method="pearson")

# If assumptions violated, use Spearman
cor.test(hyenas$stan_rank, hyenas$ageSM, method="spearman")
#stronger correlation not biased by the skew 

ggplot(hyenasF, aes(x=stan_rank, y=ageSM)) +
  geom_point(alpha=0.6) +
  geom_smooth(method="lm", se=TRUE, color="red") +
  theme_bw() +
  labs(x="Maternal Standardized Rank", y="Age at First Parturition",
       title=paste0("Correlation: r = -0.44 "))




```


