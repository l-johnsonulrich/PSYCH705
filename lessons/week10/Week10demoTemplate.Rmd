---
title: "Week 10 Demo"
output:
  html_document: default
date: "2025-10-22"
editor_options:
  chunk_output_type: console
---

Set up your workspace. 
```{r}
library(dplyr)
library(ggplot2)
library(glmmTMB)
library(DHARMa)
library(emmeans)
library(modelbased)
library(performance)
library(dagitty)
library(ggdag)
library(interplot)


setwd()

```

## 1. Interaction Effects

Example: Cooperative Vigilance in Meerkats

You’re studying how group size (GroupSize) and predator presence (Predators) affect the time each meerkat spends being vigilant (VigilanceTime).

A = GroupSize : number of meerkats in the group (continuous)
B = Predators : 0 = no predators detected, 1 = predators present
Y = VigilanceTime : proportion of time an individual spends scanning the environment

Hypothesis: 

- Larger groups have lower vigilance (they share the work).
- But when predators are around, vigilance increases, especially in small groups. 

**This "especially in small groups" indicates we might predict an interaction effect.**

```{r}
set.seed(123)

# Simulate data
n <- 200
group_size <- runif(n, 2, 20)  # groups from 2 to 20 individuals
predator <- rbinom(n, 1, 0.5)  # 0 = no predator, 1 = predator nearby

# Define the true relationship:
# baseline vigilance decreases with group size
# predator increases vigilance, but more strongly in small groups
vigilance_time <- 0.6 - 0.03 * group_size + 
                  0.25 * predator - 
                  0.02 * group_size * predator + 
                  rnorm(n, 0, 0.05)  # random noise

# Keep values within [0,1]
vigilance_time <- pmin(pmax(vigilance_time, 0), 1)

dat <- data.frame(group_size, predator = factor(predator, labels=c("Absent", "Present")), vigilance_time)

# Examine the data 














# Fit models

#First, fit a simple linear regression






#Next, let's also add the effect of predator







#Next, let's check for an interaction 









#what does this look like? 
dag <- dagitty("dag {
  V <- GS
  V <- P 
  V <- GS_P
  GS_P <- GS
  GS_P <- P
}")
ggdag(dag) + theme_dag()

summary(v3)
#this shows the direct effects for group size and predator (not the total!)

#what if we want the total effect? 





#create predicted data for plotting 


#plot the result
ggplot(dat, aes(x=group_size, y=vigilance_time, color=predator)) +
  geom_point() + 
  geom_line(data=emm, aes(x=group_size, y=emmean, color=predator)) +
  geom_ribbon(data=emm, aes(x=group_size, y=emmean, ymin=lower.CL, ymax=upper.CL, fill=predator), alpha=.4, color=NA) +
  theme_bw() +
  labs(x="Group Size", y="Proportion vigilant per meerkat", fill="Predator", color="Predator")

# How would we interpret this in natural language? 
# [Ask students to write down a sentence in their code.]




```

### Quick Discussion

- Why might vigilance decrease in larger groups? Can you think of other animals where this might happen?
- If predators are present, why might smaller groups increase vigilance more than large groups?
- What other factors (besides predator presence and group size) could moderate vigilance behavior?
- How would we represent this situation in a DAG? Which arrows would indicate direct vs. interactive effects?

```{r}
dag <- dagitty("dag {
  V <- GS
  V <- P 
  V <- GS_P
  GS_P <- GS
  GS_P <- P
}")
ggdag(dag) + theme_dag()

#add other predictors! (habitat short/long grass, time of day (low/high risk), pups in the group?)
#pups in the group might also be affected by group size... add an arrow for that... 
#this is why I somtimes like drawing these in PPT... 

```


## 2. Moderators

Example: Dyadic travel direction and meerkat calls 

You’re studying how meerkats coordinate collective movement. Do meerkat calls have an effect on the correlation of travel vectors between pairs of meerkats? 

Turning Angle from -1 to 1 where -1 indicates turning left and positive 1 indicates turning right
A: turning angle of meerkat a
B: turning angle of meerkat b
call_type: lead, alarm, sn, close, or move 

lead: given to initiate movement
alarm: anti-predator calls
sn: small frequent call given in many contexts
close: little burp-like call given to maintain proximity to other meerkats
move: given when the group speeds up in movement 

Hypothesis 1: Move and lead calls will be associated with higher correlations between meerkat A and B
Hypothesis 2: SN and close calls will have no effect on alignment. 
Hypothesis 3: Alarm calls will reduced the association/alignment between meerkat A and B. 

**This is a moderating effect! We do not expect call type to influence whether meerkat A turns left or right. We ONLY expect call type to influence the correlation between meerkat A and B!**
```{r}
set.seed(2025)

N <- 500
prop_calls <- c(move = 0.12, lead = 0.18, close = 0.30, sn = 0.20, alarm = 0.20)

# True moderation: only slopes differ by call type
slope_by_call <- c(move = 0.55,
                   lead = 0.30,
                   close = 0.05,
                   sn   = 0.05,
                   alarm= -0.25)

# No intercept difference across call types
intercept_A <- 0.02

# Noise parameters
sd_individual <- 0.20
prob_heavy_tail <- 0.12
heavy_tail_sd <- 0.8

# Assign call types
call_types <- sample(names(prop_calls), N, replace = TRUE, prob = prop_calls)
call_types <- factor(call_types, levels = c("move","lead","close","sn","alarm"))

# Simulate B
group_heading <- rt(N, df = 3) * 0.15
B_turn <- group_heading + rnorm(N, 0, sd_individual)
heavy_idx <- runif(N) < prob_heavy_tail
B_turn[heavy_idx] <- B_turn[heavy_idx] + rnorm(sum(heavy_idx), 0, heavy_tail_sd)
B_turn <- pmax(pmin(B_turn, 1), -1)

# Simulate A given B and call_type (moderation only)
A_turn <- numeric(N)
for (i in seq_len(N)) {
  slope <- slope_by_call[as.character(call_types[i])]
  noiseA <- rnorm(1, 0, sd_individual)
  if (runif(1) < prob_heavy_tail) noiseA <- rnorm(1, 0, heavy_tail_sd)
  A_turn[i] <- intercept_A + slope * B_turn[i] + noiseA
}
A_turn <- pmax(pmin(A_turn, 1), -1)

dat <- tibble(A = A_turn, B = B_turn, call_type = call_types)

# Look at your data ("dat") 







# First, fit a simple model. 





#look at model fit 



#add the moderator




#draw the DAG 
dag <- dagitty('dag {
A <- M <- B
Call -> M
A [pos="1,0"]
M [pos="2,0"]
B [pos="3,0"]
Call [pos="2,.5"]
}')
#ggdag doesn't have a good way of drawing moderators, arrows can only connect nodes so we can add an imaginary node for the moderating effect of Call on the relationship between A and B.  
ggdag(dag) +  theme_dag()

summary(c2) #let's take another look at the output here 
#how to interpret categorical variables? 
#for categorical interactions the significance here is meaningless since it's based on the reference variable (post hoc test is required)

#once you have an interaction, often better to NOT try and interpret the main model output 

estimate_slopes(c2, trend="B")
estimate_slopes(c2, trend="B", by="call_type")

#check model fit







#plotting results

#create predicted dataframe 
summary(dat$B)
emm <- as_tibble(emmeans(c2, ~call_type*B, at=list(B=seq(-1,1,.1))))

#ggplot
ggplot(data=dat, aes(x=B, y=A)) +
  geom_point(aes(color=call_type)) +
  geom_line(data=emm, aes(x=B, y=emmean)) +
  geom_ribbon(data=emm, aes(x=B, y=emmean, ymin=lower.CL, ymax=upper.CL), alpha=.5) +
  facet_grid(~call_type) +
  theme_bw() +
  labs(x = "Meerkat B's Turning Angle", y="Meerkat A's Turning Angle", color="Call Type")
  
estimate_slopes(c2, trend="B", by="call_type")



```

### Think-Pair-Share

- Why might some call types increase coordination between individuals while others reduce it?
- In your own words, what is a moderator? How is it different from a other variables like confounders? (Discuss with a neighbor and write your answer inside the demo)



## 3. More complex models! 
Let's explore the primate dataset with multiple predictors and interactions. 
```{r}
rm(list=ls()) #clear the workspace 
load("~/Dropbox/Documents_Hunter/Teaching/PSY705/lessons/week9/primates.RData")
glimpse(primates)

#what predictors? 
#what is our main question? 

#Does navigating a larger home range increase cognitive demands? 
#does home range size predict brain size? 



#are there any confounds? 



#don't necessarily have to plot ALL relationships, because the relationship might not show up without controlling for other variables (like body mass)


dag <- dagitty("dag {
  ECV <- HRS
  ECV <- BM





}")
ggdag(dag) +  theme_dag()
















#marginal effect of home range size 






#interactions..




#plotting a continous*continuous interaction 





#







```


What is VIF anyway? When is multicollinearity a problem? 
```{r}
set.seed(123)
n <- 100
X1 <- rnorm(n)
X2 <- X1 * 0.9 + rnorm(n, 0, 0.1)   # highly correlated with X1 (r ≈ 0.9)
X3 <- rnorm(n)
Y  <- 3*X1 + 2*X3 + rnorm(n)

# X1 is the main predictor of interest that has a causal relationship with Y
# X2 is highly correlated iwth X1 (we used X1 when creating X2)
# X2 does not cause any variation in Y (based on the way we created Y)

hist(Y)
hist(X1)
hist(X2)
hist(X3)

plot(X1, Y)
plot(X2, Y)
plot(X3, Y)

c1 <- lm(Y ~ X1) # simple regression we can see the strong significant relationship
summary(c1)

c2 <- lm(Y~X1 + X2) # now X1 is not significant, but X2 isn't either 
summary(c2)

check_collinearity(c2) #super high! 

c3 <- lm(Y ~ X1 + X2 + X3) # a bit better, X3 also explains variation in Y, which helps the model assign some variation to X1 and less to X2 
summary(c3)
check_collinearity(c3) #still high collineraity 


c4 <- lm(Y ~ X1 + X3) # best model 
summary(c4)
check_collinearity(c4)
simulateResiduals(c4, plot = TRUE) #also check residuals 
r2(c4)

```


Does age affect mammal height and weight? 
Non-linear predictors 
```{r}
load("mammals.RData")
hist(mammals$Age_months)
hist(mammals$Weight_g)

#does this meet assumptions?! 
ggplot(mammals, aes(Age_months, Weight_g)) + geom_point()


#dealing with non-linear predictor variables 
m1 <- glmmTMB(Weight_g ~ Age_months, data=mammals)
summary(m1)

m2 <- glmmTMB(Weight_g ~ Age_months + I(Age_months^2), data=mammals)
summary(m2)

ggplot(mammals, aes(Age_months, Weight_g)) + geom_point() +
  geom_line(data=mammals %>% mutate(pred=predict(m1)), aes(x=Age_months, y=pred), color="blue", size=1) +
  geom_line(data=mammals %>% mutate(pred=predict(m2)), aes(x=Age_months, y=pred), color="red", size=1)

#should we control for height? 
m3 <- glmmTMB(Weight_g ~ Age_months + I(Age_months^2) + Height_cm, data=mammals)
summary(m3)

#what does this mean? 
#does age not have an effect on weight? 

#compare models (look at AIC)
summary(glmmTMB(Weight_g ~ Height_cm, data=mammals)) # weight ~ height
summary(m3) # weight ~ height + age + age^2

#adding age only explains a tiny bit more than height alone 
#but age does have a huge effect on height 

m4 <- glmmTMB(Height_cm ~ Age_months + I(Age_months^2), data=mammals)
summary(m4)
summary(m2)

ggplot(mammals, aes(Age_months, Height_cm)) + geom_point() +
  geom_line(data=mammals %>% mutate(pred=predict(m4)), aes(x=Age_months, y=pred), color="red", size=1)

simulateResiduals(m4, plot = TRUE)
#interpret residuals! 



```

## Classwork: DAGs and Interactions

**Objective:** Work in small groups to explore interactions and moderators in biological data.

**Instructions:**

1. **Choose a dataset:** For example:
   - `primates` (brain size, home range, body mass, diet, group size)
   - `hyenas` (sex and rank as possible interactions?)
   - `ToothGrowth` (built in R dataset looking at supplements and dosage on tooth length)
   - `mtcars` (lots of plausible interactions)
   
2. **Build a DAG**
   - Identify your **response variable (Y)**.
   - Identify at least **two predictors (X1, X2)**.
   - Include **at least one interaction or moderator** (e.g., X1*X2 or a categorical variable moderating X1’s effect on Y).
   - Identify potential confounders or mediators.
   - Draw the DAG using `dagitty` and `ggdag` OR using powerpoint OR by hand in a notebook.

3. **Analyze**
   - Fit simple and complex models including main effects and the interaction/moderator.
   - Check model diagnostics (`simulateResiduals`, `r2`, `check_collinearity`).
   - Use `estimate_slopes` or `emmeans` to explore interaction/moderation effects.
   - Use AIC() to compare models. 

4. **Visualize**
   - Plot your interaction/moderation using `ggplot2`.
   - Use geom_point() for raw data points. 
   - Use geom_line() and geom_ribbon() for predicted model slopes and confidence intervals.
   - Label axes clearly. 

6. **Interpret**
   - Write 2-3 sentences describing your findings in **biological terms**.
   - Explain why your moderator or interaction is or is not biologically meaningful.

# Wrap-up

1. Knit your file to .html
2. Put both files in your git repo folder 
3. Use 'git pull' to download any changes from github.com
4. Use 'git add filename' to add them to git tracking
5. Use 'git commit -m "comment"' to commit them for upload
6. Use 'git push' to upload your changes from github.com 

